<h1 id="the-realignment-process">The realignment process</h1>
<h2 id="terminology">Terminology</h2>
<dl>
<dt>Tile</dt>
<dd>a source image at original or reduced scale
</dd>
<dt>Source tile</dt>
<dd>a source image at original scale
</dd>
<dt>Scaled tile</dt>
<dd>a source image at reduced scale
</dd>
<dt>Run</dt>
<dd>a single run of the microscope
</dd>
<dt>Montage</dt>
<dd>all tiles within a run taken at nominally the same x-y-position
</dd>
<dt>Slice</dt>
<dd>all tiles within a run taken at nominally the same z-position
</dd>
<dt>Model space</dt>
<dd>coordinate space for global reconstruction
</dd>
<dt>Run space</dt>
<dd>coordinate space for a run; defined relative to the model space by way of a translation
</dd>
<dt>Montage space</dt>
<dd>coordinate space for a montage; defined relative to the run space by way of a translation
</dd>
<dt>Tile space</dt>
<dd>coordinate space for a tile; defined relative to the enclosing montage by way of a grid of matching points that define subtiles
</dd>
</dl>
<h2 id="database-tables">Database tables</h2>
<p>These are organized in order of construction hierarchy, toplevel tables first.</p>
<h3 id="warpq5rundone">warpq5rundone</h3>
<p>Simple bookkeeping of which slices have been rendered at Q5 so far.</p>
<h4 id="members">Members:</h4>
<dl>
<dt>r, s</dt>
<dd>run and slice number
</dd>
</dl>
<h4 id="associated-files">Associated files:</h4>
<dl>
<dt>/lsi2/dw/170428/runalignq5/R{r}/S{s}.jpg</dt>
<dd>Entire slice at 1:5 scale
</dd>
</dl>
<h4 id="constructed-by">Constructed by:</h4>
<p>warpq5run.py</p>
<h4 id="dependencies">Dependencies:</h4>
<ul>
<li>roughq5pos</li>
<li>optimizeq5</li>
</ul>
<h4 id="see-also">See also:</h4>
<ul>
<li>runextentq5</li>
</ul>
<h3 id="runextentq5">runextentq5</h3>
<p>Coordinates in run space that are included in the rendered images at Q5</p>
<h4 id="members-1">Members:</h4>
<dl>
<dt>r</dt>
<dd>run number
</dd>
<dt>x0, y0, x1, y1</dt>
<dd>coordinates of image in run space<br />
x0, y0 are inclusive; x1, y1 are exclusive.
</dd>
</dl>
<h4 id="constructed-by-1">Constructed by:</h4>
<p>warpq5run.py</p>
<h4 id="dependencies-1">Dependencies:</h4>
<ul>
<li>roughq5pos</li>
<li>optimizeq5</li>
</ul>
<h3 id="roughq5pos">roughq5pos</h3>
<p>Slightly misnamed, this table contains positions of montages within a run.</p>
<h4 id="members-2">Members:</h4>
<dl>
<dt>r, m</dt>
<dd>run and montage numbers
</dd>
<dt>x, y</dt>
<dd>coordinates of given montage
</dd>
</dl>
<h4 id="constructed-by-2">Constructed by:</h4>
<p>optimizeq5.py</p>
<h4 id="dependencies-2">Dependencies:</h4>
<ul>
<li>slicealignq5</li>
<li>montagealignq5relhp</li>
<li>montagealignattouchq5relhp</li>
</ul>
<h4 id="see-also-1">See also:</h4>
<ul>
<li>optimizeq5</li>
</ul>
<h4 id="notes">Notes</h4>
<p>By construction, the average of all x-values for montages within a run is zero. Same for y-values.</p>
<h3 id="optimizeq5">optimizeq5</h3>
<p>Results of optimization within runs at Q5</p>
<h4 id="members-3">Members:</h4>
<dl>
<dt>r, m, s</dt>
<dd>run, montage, slice number
</dd>
<dt>nx, ny</dt>
<dd>grid index within a tile. nx, ny run from 0 to 6, inclusive.
</dd>
<dt>x, y</dt>
<dd>montage coordinates of a grid point, see <em>Transformations</em> below.
</dd>
<dt>dx, dy</dt>
<dd>displacement at that grid point, see <em>Transformations</em> below.
</dd>
<dt>supported</dt>
<dd>indicates whether this grid point is supported by data. (If not, it is the result of interpolation.)
</dd>
</dl>
<h4 id="coordinate-transformations">Coordinate transformations</h4>
<ul>
<li>To transform from montage coordinates to run coordinates, add the x-, y-values stored in roughposq5.</li>
<li>To transform from run coordinates to pixels in the &quot;runalignq5&quot; images, subtract the x0-, y0-values stored in runextentq5.</li>
<li>To transform between run coordinates and pixel coordinates in a given scaled source tile, use the runToQuad() and quadToRun() function of the Transformer class in warpq5run. Not sure which quad a pixel belongs to? Use the findInRun() or findInMontage() functions, or the rawToRun() function.</li>
</ul>
<h3 id="slicealignq5">slicealignq5</h3>
<p>Alignment between tiles within a slice</p>
<h3 id="members-4">Members:</h3>
<dl>
<dt>r, s</dt>
<dd>run and slice ID
</dd>
<dt>m1, m2</dt>
<dd>montage IDs within the slice
</dd>
<dt>ix1, iy1</dt>
<dd>subtile IDs within the first montage (counting 0..4, inclusive)
</dd>
<dt>ix2, iy2</dt>
<dd>subtile IDs within the second montage (counting 0..4, inclusive)
</dd>
<dt>dx, dy, sx, sy, snr</dt>
<dd>results from primary “swim” run
</dd>
<dt>dxb, dyb, sxb, syb, snrb</dt>
<dd>results from secondary “swim” run
</dd>
<dt>dxc, dyc, sxc, syc, snrc</dt>
<dd>results from tertiary “swim” run
</dd>
<dt>x0, y0</dt>
<dd>position of used ROI in first subtile (see below)
</dd>
</dl>
<h3 id="notes-1">Notes:</h3>
<ul>
<li>For a top-to-bottom overlap (horizontal strip of overlap), y1=4, y2=0, and ix1=ix2.</li>
<li>For a left-to-right overlap (vertical strip of overlap), x1=4, x2=0, and iy1=iy2.</li>
<li>For top-to-bottom overlap, the primary alignment is done in a 684x342 rectangle centered at (342, 342+171) in the (ix1,iy1)-th subtile of the first montage and at (342, 342-171) in the (ix2,iy2)-th subtile of the second montage.</li>
<li>For left-to-right overlap, the primary alignment is done in a 342x684 rectangle centered at (342+171, 342) in the (ix1,iy1)-th subtile of the first montage and at (342-171, 342) in the (ix2,iy2)-th subtile of the second montage.</li>
<li>To make this math slightly less painful, the center can be calculated as p1 ≡ (X/2 + dx0/2, Y/2 + dy0/2) in the first montage and p2 ≡ (X/2 - dx0/2, Y/2 - dy0/2) in the second, where X = Y = 684, and the size of the region can be calculated as (X-dx0) x (Y-dy0).</li>
<li>The secondary overlap is done in a half-sized rectangle centered at p1 - (dx,dy)/2 in the first montage and at p2 + (dx,dy)/2 in the second.</li>
<li>The tertiary overlap is done in a half-sized rectangle centered at p1 - (dx+dxb,dy+dyb)/2 in the first montage and at p2 + (dx+dxb,dy+dyb)/2 in the second.</li>
<li>The final implied match is between the point p1 - (dx+dxb+dxc,dy+dyb+dyc)/2 and p2 + (dx+dxb+dxc,dy+dyb+dyc)/2.</li>
<li>The various SNR values cannot be directly compared because they are not across the same rectangle.</li>
</ul>
<h4 id="constructed-by-3">Constructed by:</h4>
<p>slicealignq5.py</p>
<h4 id="dependencies-3">Dependencies:</h4>
<p>None</p>
<h4 id="see-also-2">See also:</h4>
<ul>
<li>slicealignq5pos</li>
</ul>
<h3 id="slicealignq5pos">slicealignq5pos</h3>
<p>View onto slicealignq5 that precalculates the final matching points</p>
<h4 id="members-5">Members</h4>
<dl>
<dt>r,s</dt>
<dd>as in slicealignq5
</dd>
<dt>m1, m2</dt>
<dd>as in slicealignq5
</dd>
<dt>ix1, iy1, ix2, iy2</dt>
<dd>as in slicealignq5
</dd>
<dt>dx0, dy</dt>
<dd>as in slicealignq5
</dd>
<dt>x1, y1</dt>
<dd>calculated as p1 - (dx+dxb+dxc,dy+dyb+dyc)/2 from slicealignq5
</dd>
<dt>x2, y2</dt>
<dd>calculated as p2 + (dx+dxb+dxc,dy+dyb+dyc)/2 from slicealignq5
</dd>
</dl>
